name: ğŸ³ Get AMD64 Docker Images for Linux x86_64 (Ubuntu 22.04)

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'å¡«å†™é•œåƒåï¼Œå¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼ˆå¦‚ alpine:latest,nginx:alpineï¼‰'
        required: true
        default: 'alpine:latest,alpine/curl,busybox:stable-glibc'

jobs:
  pull_and_package:
    runs-on: ubuntu-22.04  # âœ… æ˜ç¡®æŒ‡å®š Ubuntu 22.04
    permissions:
      contents: write  # å¿…é¡»æƒé™ï¼Œç”¨äºåˆ›å»º/æ›´æ–° Release

    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Pull & Package Images (linux/amd64)
        run: |
          # è®¾ç½®å¹³å°ç¯å¢ƒå˜é‡
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"
          
          echo "=== å¼€å§‹æ‹‰å–ä»¥ä¸‹é•œåƒï¼ˆx86_64æ¶æ„ï¼‰==="
          for image in "${image_array[@]}"; do
            echo "â†’ æ‹‰å–: $image"
            docker pull "$image" --platform "linux/amd64"
          done
          
          echo "=== å¼€å§‹æ‰“åŒ… ==="
          for image in "${image_array[@]}"; do
            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶åï¼šæ›¿æ¢ / å’Œ : ä¸º _
            safe_name="${image//\//_}"
            safe_name="${safe_name//:/_}"
            filename="${safe_name}-amd64"
            
            echo "â†’ æ‰“åŒ…: $image â†’ $filename.tar.gz"
            docker save "$image" -o "${filename}.tar"
            gzip -9 "${filename}.tar"  # æœ€é«˜å‹ç¼©
            # tar.gz è‡ªåŠ¨ç”Ÿæˆï¼ŒåŸ tar æ–‡ä»¶å·²å‹ç¼©æ— éœ€ä¿ç•™
          done

      - name: ğŸ“‹ åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        id: list_files
        run: |
          echo "=== ç”Ÿæˆçš„é•œåƒåŒ… ==="
          files=$(find . -name "*.tar.gz" -printf "%f\n" | sort)
          echo "$files"
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # ç”Ÿæˆå¸¦æ—¶åŒºçš„ Release åç§°
          release_name="ğŸ“¦ Docker Images for x86_64 â€¢ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          echo "RELEASE_NAME=$release_name" >> $GITHUB_ENV

      - name: ğŸš« åˆ é™¤æ—§ Release èµ„äº§ï¼ˆé¿å…é‡å¤ï¼‰
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'fixed-amd64-release';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              const assets = await github.rest.repos.listReleaseAssets({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id
              });
              for (const asset of assets.data) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
                console.log(`ğŸ—‘ï¸ åˆ é™¤æ—§èµ„äº§: ${asset.name}`);
              }
            } catch (error) {
              if (error.status !== 404) throw error;
              console.log('æœªæ‰¾åˆ°æ—§ Releaseï¼Œå°†åˆ›å»ºæ–° Release');
            }

      - name: ğŸ åˆ›å»º/æ›´æ–° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fixed-amd64-release  # å›ºå®šæ ‡ç­¾ï¼Œæ–¹ä¾¿ä½ è®°ä½ä¸‹è½½åœ°å€
          name: ${{ env.RELEASE_NAME }}
          body: |
            [![Github](https://img.shields.io/badge/RELEASE%20%20:DockerTarBuilder-123456?logo=github&logoColor=fff&labelColor=green&style=for-the-badge)](https://www.bilibili.com/video/BV1EZ421M7mL)
            [![å›½å†…åŠ é€Ÿç«™](https://img.shields.io/badge/%E5%9B%BD%E5%86%85%E5%8A%A0%E9%80%9F%E7%AB%99%E4%B8%8B%E8%BD%BD-FC7C0D?logo=github&logoColor=fff&labelColor=000&style=for-the-badge)](https://wkdaily.cpolar.top/archives/1)
            
            ### ğŸ“¥ å¦‚ä½•ä½¿ç”¨ï¼Ÿ
            ```bash
            gunzip -c your-image.tar.gz | docker load
            # æˆ–
            docker load -i your-image.tar.gz
            ```

            ### ğŸ“º æ•™å­¦è§†é¢‘
            [![Bilibili](https://img.shields.io/badge/Bilibili-%E7%82%B9%E5%87%BB%E8%A7%82%E7%9C%8B-FB7299?logo=bilibili&logoColor=fff&style=for-the-badge)](https://www.bilibili.com/video/BV1yyq6YREdF)

            ### ğŸ“¦ æœ¬æ¬¡åŒ…å«é•œåƒï¼š
            ```
            ${{ env.FILES }}
            ```
          draft: false
          prerelease: false

      - name: â¬†ï¸ ä¸Šä¼ æ–°èµ„äº§
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fixed-amd64-release
          files: |
            *.tar.gz
          append_body: false  # ä¸è¿½åŠ ï¼Œä½¿ç”¨ä¸Šé¢å®šä¹‰çš„å®Œæ•´ body
