name: ğŸš€ Skopeo æµå¼æ‰“åŒ…è¶…å¤§é•œåƒï¼ˆæ— ç£ç›˜å‹åŠ›ï¼‰

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'å¡«å†™é•œåƒåï¼Œå¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”'
        required: true
        default: 'quay.io/docling-project/docling-serve'

jobs:
  pack_with_skopeo_stream:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
        run: df -h .

      - name: ğŸ§° å®‰è£… Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: ğŸŒŠ ä½¿ç”¨ Skopeo + æµå¼å‹ç¼©ï¼ˆç»ˆæçœç©ºé—´æ–¹æ¡ˆï¼‰
        run: |
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"
          
          for image in "${image_array[@]}"; do
            image=$(echo "$image" | xargs)
            [[ -z "$image" ]] && continue
            
            echo "â†’ å¤„ç†é•œåƒ: $image"
            safe_name="${image//\//_}"
            safe_name="${safe_name//:/_}"
            filename="${safe_name}-amd64.tar.gz"
            
            # æ ¸å¿ƒï¼šç›´æ¥è¾“å‡ºåˆ° stdout å¹¶ç®¡é“ç»™ gzipï¼Œé¿å…ä¸­é—´æ–‡ä»¶
            skopeo copy \
              --override-arch amd64 \
              --retry-times 3 \
              "docker://$image" \
              "docker-archive:/dev/stdout" | gzip -9 > "$filename"
            
            echo "âœ“ æ‰“åŒ…å®Œæˆ: $filename"
            ls -lh "$filename"
          done

      - name: ğŸ’¾ æ£€æŸ¥æœ€ç»ˆç£ç›˜ç©ºé—´ï¼ˆéªŒè¯æ˜¯å¦èŠ‚çœæˆåŠŸï¼‰
        run: df -h .

      - name: ğŸ“‹ åˆ—å‡ºç”Ÿæˆæ–‡ä»¶
        id: list_files
        run: |
          files=$(find . -name "*.tar.gz" -printf "%f\n" | sort)
          [[ -z "$files" ]] && { echo "âŒ æ— æ–‡ä»¶ç”Ÿæˆ"; exit 1; }
          echo "$files"
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          release_name="ğŸ“¦ æµå¼æ‰“åŒ… â€¢ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          echo "RELEASE_NAME=$release_name" >> $GITHUB_ENV

      - name: ğŸš« åˆ é™¤æ—§èµ„äº§
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'stream-amd64-release';
            try {
              const release = await github.rest.repos.getReleaseByTag({owner: context.repo.owner, repo: context.repo.repo, tag});
              const assets = await github.rest.repos.listReleaseAssets({owner: context.repo.owner, repo: context.repo.repo, release_id: release.data.id});
              for (const asset of assets.data) {
                await github.rest.repos.deleteReleaseAsset({owner: context.repo.owner, repo: context.repo.repo, asset_id: asset.id});
                console.log(`ğŸ—‘ï¸ åˆ é™¤: ${asset.name}`);
              }
            } catch (error) {
              if (error.status !== 404) throw error;
            }

      - name: ğŸ åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: stream-amd64-release
          name: ${{ env.RELEASE_NAME }}
          body: |
            ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            ```bash
            docker load -i your-image.tar.gz
            ```
            ### ğŸ“¦ åŒ…å«é•œåƒ
            ```
            ${{ env.FILES }}
            ```

      - name: â¬†ï¸ ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: stream-amd64-release
          files: '*.tar.gz'
