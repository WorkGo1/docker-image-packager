name: ğŸš€ Skopeo æ‰“åŒ…ä»»æ„ Docker é•œåƒï¼ˆæ”¯æŒè¶…å¤§é•œåƒï¼‰

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'å¡«å†™é•œåƒåï¼Œå¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼ˆå¦‚ nginx:alpine,quay.io/docling-project/docling-serveï¼‰'
        required: true
        default: 'alpine:latest,busybox:stable'

jobs:
  pack_with_skopeo:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: df -h /tmp

      - name: ğŸ§° å®‰è£… Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: ğŸ³ ä½¿ç”¨ Skopeo æ‹‰å–å¹¶æ‰“åŒ…é•œåƒï¼ˆä¸ç»è¿‡ Dockerï¼Œçœç©ºé—´ï¼ï¼‰
        run: |
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"
          
          echo "=== å¼€å§‹æ‰“åŒ…ä»¥ä¸‹é•œåƒï¼ˆlinux/amd64ï¼‰==="
          for image in "${image_array[@]}"; do
            # æ¸…ç†é•œåƒåä¸­çš„ç©ºæ ¼
            image=$(echo "$image" | xargs)
            if [[ -z "$image" ]]; then continue; fi
            
            echo "â†’ å¤„ç†é•œåƒ: $image"
            
            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶åï¼ˆæ›¿æ¢ / å’Œ : ä¸º _ï¼‰
            safe_name="${image//\//_}"
            safe_name="${safe_name//:/_}"
            filename="${safe_name}-amd64"
            
            # ä½¿ç”¨ skopeo ç›´æ¥å¤åˆ¶åˆ° tar æ–‡ä»¶ï¼ˆè·³è¿‡ Docker daemonï¼‰
            skopeo copy \
              --override-arch amd64 \
              --retry-times 3 \
              "docker://$image" \
              "docker-archive:${filename}.tar"
            
            # å‹ç¼©å¹¶æ¸…ç†åŸæ–‡ä»¶
            gzip -9 "${filename}.tar"
            echo "âœ“ æ‰“åŒ…å®Œæˆ: ${filename}.tar.gz"
            
            # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
            ls -lh "${filename}.tar.gz"
          done

      - name: ğŸ“‹ åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„ .tar.gz æ–‡ä»¶
        id: list_files
        run: |
          echo "=== ç”Ÿæˆçš„é•œåƒåŒ…åˆ—è¡¨ ==="
          files=$(find . -maxdepth 1 -name "*.tar.gz" -printf "%f\n" | sort)
          if [[ -z "$files" ]]; then
            echo "âŒ æœªç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼"
            exit 1
          fi
          echo "$files"
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # ç”Ÿæˆå¸¦æ—¶åŒºçš„ Release åç§°
          release_name="ğŸ“¦ Skopeo æ‰“åŒ… â€¢ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          echo "RELEASE_NAME=$release_name" >> $GITHUB_ENV

      - name: ğŸš« åˆ é™¤æ—§ Release èµ„äº§
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'skopeo-amd64-release';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              const assets = await github.rest.repos.listReleaseAssets({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id
              });
              for (const asset of assets.data) {
                await github.rest.repos.deleteReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  asset_id: asset.id
                });
                console.log(`ğŸ—‘ï¸ åˆ é™¤æ—§èµ„äº§: ${asset.name}`);
              }
            } catch (error) {
              if (error.status !== 404) throw error;
              console.log('â„¹ï¸ æœªæ‰¾åˆ°æ—§ Releaseï¼Œå°†åˆ›å»ºæ–° Release');
            }

      - name: ğŸ åˆ›å»º/æ›´æ–° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: skopeo-amd64-release
          name: ${{ env.RELEASE_NAME }}
          body: |
            [![Github](https://img.shields.io/badge/RELEASE%20%20:DockerTarBuilder-123456?logo=github&logoColor=fff&labelColor=green&style=for-the-badge)](https://www.bilibili.com/video/BV1EZ421M7mL)
            [![å›½å†…åŠ é€Ÿç«™](https://img.shields.io/badge/%E5%9B%BD%E5%86%85%E5%8A%A0%E9%80%9F%E7%AB%99%E4%B8%8B%E8%BD%BD-FC7C0D?logo=github&logoColor=fff&labelColor=000&style=for-the-badge)](https://wkdaily.cpolar.top/archives/1)
            
            ### ğŸ“¥ å¦‚ä½•ä½¿ç”¨ï¼Ÿ
            ```bash
            # æ–¹æ³•1ï¼šå…ˆè§£å‹å†å¯¼å…¥
            gunzip -c your-image.tar.gz | docker load
            
            # æ–¹æ³•2ï¼šç›´æ¥å¯¼å…¥ï¼ˆDocker 20.10+ æ”¯æŒï¼‰
            docker load -i your-image.tar.gz
            ```

            ### ğŸ“º æ•™å­¦è§†é¢‘
            [![Bilibili](https://img.shields.io/badge/Bilibili-%E7%82%B9%E5%87%BB%E8%A7%82%E7%9C%8B-FB7299?logo=bilibili&logoColor=fff&style=for-the-badge)](https://www.bilibili.com/video/BV1yyq6YREdF)

            ### ğŸ“¦ æœ¬æ¬¡åŒ…å«é•œåƒï¼š
            ```
            ${{ env.FILES }}
            ```
          draft: false
          prerelease: false

      - name: â¬†ï¸ ä¸Šä¼ æ–°èµ„äº§
        uses: softprops/action-gh-release@v2
        with:
          tag_name: skopeo-amd64-release
          files: |
            *.tar.gz
          append_body: false
