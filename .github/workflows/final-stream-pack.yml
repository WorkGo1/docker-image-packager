name: Dockeré•œåƒæ‰“åŒ…å™¨ï¼ˆæ”¯æŒè¶…å¤§é•œåƒ + è‡ªåŠ¨åˆ†å·ï¼‰

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'å¡«å†™é•œåƒåï¼Œå¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼ˆæ¨èä¸€æ¬¡ä¸€ä¸ªè¶…å¤§é•œåƒï¼‰'
        required: true
        default: 'quay.io/docling-project/docling-serve'

jobs:
  pack_huge_images:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å¿…é¡»æƒé™ï¼Œç”¨äºåˆ é™¤/åˆ›å»º Release å’Œ Tag

    steps:
      - name: ğŸ“‚ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
        run: df -h .

      - name: ğŸ§° å®‰è£… Skopeo å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: ğŸŒŠ æµå¼æ‹‰å–+å‹ç¼©ï¼ˆä¸å ç£ç›˜ï¼ï¼‰
        run: |
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"
          
          for image in "${image_array[@]}"; do
            image=$(echo "$image" | xargs)  # å»é™¤é¦–å°¾ç©ºæ ¼
            [[ -z "$image" ]] && continue
            
            echo "â†’ å¼€å§‹å¤„ç†: $image"
            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶åï¼ˆæ›¿æ¢ / å’Œ :ï¼‰
            safe_name="${image//\//_}"
            safe_name="${safe_name//:/_}"
            filename="${safe_name}-amd64.tar.gz"
            
            # â­ æ ¸å¿ƒï¼šæµå¼å¤„ç†ï¼Œç›´æ¥è¾“å‡ºåˆ° gzipï¼Œä¸å†™ä¸­é—´æ–‡ä»¶
            skopeo copy \
              --override-arch amd64 \
              --retry-times 3 \
              "docker://$image" \
              "docker-archive:/dev/stdout" | gzip -9 > "$filename"
            
            echo "âœ“ æ‰“åŒ…æˆåŠŸ: $filename"
            ls -lh "$filename"
          done

      - name: ğŸ’¾ æ£€æŸ¥æ‰“åŒ…åç£ç›˜ç©ºé—´
        run: df -h .

      - name: ğŸ“‹ è®°å½•ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
        id: list_files
        run: |
          FILE=$(find . -maxdepth 1 -name "*.tar.gz" | head -n1)
          if [[ ! -f "$FILE" ]]; then
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆä»»ä½•é•œåƒåŒ…ï¼"
            exit 1
          fi
          echo "å¤„ç†æ–‡ä»¶: $FILE"
          echo "SOURCE_FILE=$FILE" >> $GITHUB_ENV
          
          # ç”Ÿæˆå¸¦æ—¶é—´çš„ Release æ ‡é¢˜
          release_title="Dockeré•œåƒåŒ… â€¢ $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
          echo "RELEASE_TITLE=$release_title" >> $GITHUB_ENV

      - name: âœ‚ï¸ è‡ªåŠ¨åˆ†å·ï¼ˆæ¯å· 1.9GBï¼Œç•™å®‰å…¨ä½™é‡ï¼‰
        run: |
          FILE="${{ env.SOURCE_FILE }}"
          if [[ ! -f "$FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æºæ–‡ä»¶ï¼"
            exit 1
          fi
          
          echo "â†’ å¼€å§‹åˆ†å·: $FILE"
          # åˆ†å·å‹ç¼©ï¼Œæ¯å· 1900MBï¼ˆç•™100MBä½™é‡ï¼Œç¡®ä¿ < 2GBï¼‰
          split -b 1900M -d "$FILE" "$FILE.part_"
          echo "âœ“ åˆ†å·å®Œæˆï¼Œç”Ÿæˆæ–‡ä»¶ï¼š"
          ls -lh "$FILE.part_"*
          
          # ç”Ÿæˆåˆå¹¶è„šæœ¬
          echo '#!/bin/bash' > merge.sh
          echo '# ğŸ’ æ‚Ÿç©ºçš„æ—¥å¸¸ - é•œåƒåˆ†å·åˆå¹¶è„šæœ¬' >> merge.sh
          echo '# è®¸å¯åè®®ï¼šCC BY-NC-SA 4.0' >> merge.sh
          echo '' >> merge.sh
          echo 'echo "ğŸ”„ æ­£åœ¨åˆå¹¶åˆ†å·..."' >> merge.sh
          echo 'cat *.part_* > image.tar.gz' >> merge.sh
          echo 'echo "âœ… åˆå¹¶å®Œæˆï¼"' >> merge.sh
          echo '' >> merge.sh
          echo 'echo "ğŸ³ æ­£åœ¨å¯¼å…¥ Docker..."' >> merge.sh
          echo 'docker load -i image.tar.gz' >> merge.sh
          echo '' >> merge.sh
          echo 'if [ $? -eq 0 ]; then' >> merge.sh
          echo '  echo "ğŸ‰ å¯¼å…¥æˆåŠŸï¼"' >> merge.sh
          echo '  echo "ğŸ“š æ•™ç¨‹ä¸æ”¯æŒï¼šhttps://wkdaily.cpolar.top/archives/1"' >> merge.sh
          echo 'else' >> merge.sh
          echo '  echo "âŒ å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ã€‚"' >> merge.sh
          echo 'fi' >> merge.sh
          chmod +x merge.sh
          chmod +x merge.sh
          echo "ğŸ“„ åˆå¹¶è„šæœ¬å·²ç”Ÿæˆ: merge.sh"

      - name: ğŸ—‘ï¸ã€å…³é”®ã€‘å½»åº•åˆ é™¤æ—§ Release å’Œ Tag
        uses: actions/github-script@v7
        with:
          script: |
            const TAG_NAME = 'wukong-amd64-release';
            const { owner, repo } = context.repo;
            
            try {
              // 1. å°è¯•è·å–æ—§ Release
              const release = await github.rest.repos.getReleaseByTag({
                owner, repo, tag: TAG_NAME
              });
              
              // 2. åˆ é™¤æ—§ Release
              await github.rest.repos.deleteRelease({
                owner, repo, release_id: release.data.id
              });
              console.log('âœ… æ—§ Release å·²åˆ é™¤');
              
            } catch (error) {
              if (error.status === 404) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°æ—§ Releaseï¼Œè·³è¿‡åˆ é™¤');
              } else {
                console.error('âš ï¸ åˆ é™¤ Release å¤±è´¥:', error);
              }
            }
            
            try {
              // 3. åˆ é™¤æ—§ Tagï¼ˆç¡®ä¿å®Œå…¨å¹²å‡€ï¼‰
              await github.rest.git.deleteRef({
                owner, repo, ref: 'tags/' + TAG_NAME
              });
              console.log('âœ… æ—§ Tag å·²åˆ é™¤');
            } catch (error) {
              if (error.status === 422 && error.message.includes('Reference does not exist')) {
                console.log('â„¹ï¸ æ—§ Tag ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤');
              } else {
                console.error('âš ï¸ åˆ é™¤ Tag å¤±è´¥:', error);
              }
            }

      - name: ğŸ åˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸€æ­¥åˆ°ä½ï¼ï¼‰
        uses: softprops/action-gh-release@v2
        with:
          tag_name: wukong-amd64-release
          name: ${{ env.RELEASE_TITLE }}
          body: |            
            ### ğŸ“¥ å†…ç½‘å¯¼å…¥æ–¹æ³•
            1. ä¸‹è½½æœ¬ Release ä¸‹æ‰€æœ‰ `*.part_*` æ–‡ä»¶å’Œ `merge.sh`
            2. æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹
            3. æ‰§è¡Œï¼š
               ```bash
               chmod +x merge.sh
               ./merge.sh
               ```

            ### ğŸ“¦ æœ¬æ¬¡æ‰“åŒ…é•œåƒ
            ```
            ${{ env.SOURCE_FILE }}
            ```
          draft: false
          prerelease: false
          files: |  # ğŸ‘ˆ å…³é”®ï¼šåœ¨è¿™é‡Œç›´æ¥æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶ï¼
            *.part_*
            merge.sh
          overwrite_files: true  # è¦†ç›–åŒåæ–‡ä»¶
