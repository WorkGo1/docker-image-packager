name: ğŸš€ ç»ˆæç‰ˆï¼šæµå¼æ‰“åŒ…è¶…å¤§ Docker é•œåƒï¼ˆå›ºå®š Releaseï¼‰

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'å¡«å†™é•œåƒåï¼Œå¤šä¸ªç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼ˆæ¨èä¸€æ¬¡ä¸€ä¸ªè¶…å¤§é•œåƒï¼‰'
        required: true
        default: 'quay.io/docling-project/docling-serve'

jobs:
  pack_huge_images:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å¿…é¡»æƒé™ï¼Œç”¨äºåˆ é™¤/åˆ›å»º Release å’Œ Tag

    steps:
      - name: ğŸ“‚ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
        run: df -h .

      - name: ğŸ§° å®‰è£… Skopeo å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: ğŸŒŠ æµå¼æ‹‰å–+å‹ç¼©ï¼ˆä¸å ç£ç›˜ï¼ï¼‰
        run: |
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"
          
          for image in "${image_array[@]}"; do
            image=$(echo "$image" | xargs)  # å»é™¤é¦–å°¾ç©ºæ ¼
            [[ -z "$image" ]] && continue
            
            echo "â†’ å¼€å§‹å¤„ç†: $image"
            # ç”Ÿæˆå®‰å…¨æ–‡ä»¶åï¼ˆæ›¿æ¢ / å’Œ :ï¼‰
            safe_name="${image//\//_}"
            safe_name="${safe_name//:/_}"
            filename="${safe_name}-amd64.tar.gz"
            
            # â­ æ ¸å¿ƒï¼šæµå¼å¤„ç†ï¼Œç›´æ¥è¾“å‡ºåˆ° gzipï¼Œä¸å†™ä¸­é—´æ–‡ä»¶
            skopeo copy \
              --override-arch amd64 \
              --retry-times 3 \
              "docker://$image" \
              "docker-archive:/dev/stdout" | gzip -9 > "$filename"
            
            echo "âœ“ æ‰“åŒ…æˆåŠŸ: $filename"
            ls -lh "$filename"
          done

      - name: ğŸ’¾ æ£€æŸ¥æ‰“åŒ…åç£ç›˜ç©ºé—´
        run: df -h .

      - name: ğŸ“‹ è®°å½•ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
        id: list_files
        run: |
          files=$(find . -maxdepth 1 -name "*.tar.gz" -printf "%f\n" | sort)
          if [[ -z "$files" ]]; then
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆä»»ä½•é•œåƒåŒ…ï¼"
            exit 1
          fi
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          echo "$files"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "FILES<<EOF" >> $GITHUB_ENV
          echo "$files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # ç”Ÿæˆå¸¦æ—¶é—´çš„ Release æ ‡é¢˜
          release_title="ğŸ“¦ æ‚Ÿç©ºé•œåƒåŒ… â€¢ $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
          echo "RELEASE_TITLE=$release_title" >> $GITHUB_ENV

      - name: ğŸ—‘ï¸ã€å…³é”®ã€‘å½»åº•åˆ é™¤æ—§ Release å’Œ Tag
        uses: actions/github-script@v7
        with:
          script: |
            const TAG_NAME = 'wukong-amd64-release';
            const { owner, repo } = context.repo;
            
            try {
              // 1. å°è¯•è·å–æ—§ Release
              const release = await github.rest.repos.getReleaseByTag({
                owner, repo, tag: TAG_NAME
              });
              
              // 2. åˆ é™¤æ—§ Release
              await github.rest.repos.deleteRelease({
                owner, repo, release_id: release.data.id
              });
              console.log('âœ… æ—§ Release å·²åˆ é™¤');
              
            } catch (error) {
              if (error.status === 404) {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°æ—§ Releaseï¼Œè·³è¿‡åˆ é™¤');
              } else {
                console.error('âš ï¸ åˆ é™¤ Release å¤±è´¥:', error);
                // ä¸ä¸­æ–­æµç¨‹
              }
            }
            
            try {
              // 3. åˆ é™¤æ—§ Tagï¼ˆç¡®ä¿å®Œå…¨å¹²å‡€ï¼‰
              await github.rest.git.deleteRef({
                owner, repo, ref: 'tags/' + TAG_NAME
              });
              console.log('âœ… æ—§ Tag å·²åˆ é™¤');
            } catch (error) {
              if (error.status === 422 && error.message.includes('Reference does not exist')) {
                console.log('â„¹ï¸ æ—§ Tag ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤');
              } else {
                console.error('âš ï¸ åˆ é™¤ Tag å¤±è´¥:', error);
              }
            }

      - name: ğŸ åˆ›å»ºå…¨æ–° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: wukong-amd64-release  # å›ºå®š Tagï¼Œæ–¹ä¾¿æ”¶è—
          name: ${{ env.RELEASE_TITLE }}
          body: |
            [![æ‚Ÿç©ºçš„æ—¥å¸¸](https://img.shields.io/badge/RELEASE%20%20:%E6%82%9F%E7%A9%BA%E9%95%9C%E5%83%8F%E5%8C%85-123456?logo=github&logoColor=fff&labelColor=green&style=for-the-badge)](https://wkdaily.cpolar.top/archives/1)
            [![å›½å†…åŠ é€Ÿä¸‹è½½](https://img.shields.io/badge/%E5%9B%BD%E5%86%85%E5%8A%A0%E9%80%9F%E4%B8%8B%E8%BD%BD-FC7C0D?logo=github&logoColor=fff&labelColor=000&style=for-the-badge)](https://wkdaily.cpolar.top/archives/1)
            
            ### ğŸ“¥ å¯¼å…¥å†…ç½‘ä½¿ç”¨æ–¹æ³•
            ```bash
            # æ¨èæ–¹å¼ï¼ˆè‡ªåŠ¨è§£å‹å¯¼å…¥ï¼‰
            docker load -i your-image.tar.gz
            
            # æˆ–æ‰‹åŠ¨è§£å‹åå¯¼å…¥
            gunzip -c your-image.tar.gz | docker load
            ```

            ### ğŸ“º æ•™å­¦è§†é¢‘
            [![Bilibili æ•™ç¨‹](https://img.shields.io/badge/Bilibili-%E7%82%B9%E5%87%BB%E8%A7%82%E7%9C%8B-FB7299?logo=bilibili&logoColor=fff&style=for-the-badge)](https://www.bilibili.com/video/BV1yyq6YREdF)

            ### ğŸ“¦ æœ¬æ¬¡æ‰“åŒ…åŒ…å«é•œåƒ
            ```
            ${{ env.FILES }}
            ```
          draft: false
          prerelease: false

      - name: â¬†ï¸ ä¸Šä¼ é•œåƒåŒ…åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: wukong-amd64-release
          files: '*.tar.gz'
          overwrite: true  # è¦†ç›–åŒåæ–‡ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰
